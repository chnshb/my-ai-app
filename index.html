<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConsensusAI - å…±è¯†å¯¼å‘å‹å¿ƒç†å’¨è¯¢å¹³å°</title>
    <style>
        /* ä¸“ä¸šå•†åŠ¡é£æ ¼ */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #1abc9c;
            --danger-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --success-color: #27ae60;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* ä¸“ä¸šå¤´éƒ¨ */
        .navbar {
            background: white;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
        }
        
        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* ä¸»å®¹å™¨ */
        .app-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 25px;
            height: calc(100vh - 100px);
        }
        
        /* å·¦ä¾§é¢æ¿ - ä¼šè¯ç®¡ç† */
        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }
        
        /* ä¸­é—´ - å¤šäººèŠå¤©å®¤ */
        .chat-room {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* å³ä¾§ - ç”¨æˆ·é¢æ¿å’Œå·¥å…· */
        .right-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        }
        
        /* ä¸“ä¸šæŒ‰é’® */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        /* ç”¨æˆ·å¤´åƒ */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            max-width: 70%;
            margin: 15px;
            padding: 18px;
            border-radius: 12px;
            position: relative;
            animation: slideIn 0.3s ease;
        }
        
        .user-message {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-bottom-left-radius: 4px;
        }
        
        /* å…±è¯†è¿›åº¦æ¡ */
        .consensus-progress {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
            transition: width 0.5s ease;
        }
        
        /* å…è´£å£°æ˜ */
        .disclaimer {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            color: #856404;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 250px 1fr;
            }
            .right-panel {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">
            <div class="logo-icon">C</div>
            <span>ConsensusAI</span>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="font-size: 14px; color: #666;">
                <span>ä¸“ä¸šç‰ˆ</span>
                <span style="margin: 0 10px">|</span>
                <span id="online-count">åœ¨çº¿: 2äºº</span>
            </div>
            <button class="btn btn-primary" onclick="showNewSessionModal()">
                <span>+</span> æ–°å»ºä¼šè¯
            </button>
        </div>
    </nav>
    
    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div class="app-container">
        <!-- å·¦ä¾§ï¼šä¼šè¯åˆ—è¡¨ -->
        <div class="sidebar">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">ä¼šè¯åˆ—è¡¨</h3>
            <div id="session-list">
                <!-- åŠ¨æ€åŠ è½½ä¼šè¯ -->
            </div>
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <button class="btn" onclick="inviteUsers()" style="width: 100%; background: #f8f9fa;">
                    <span>ğŸ‘¥</span> é‚€è¯·æˆå‘˜
                </button>
                <button class="btn" onclick="showSettings()" style="width: 100%; margin-top: 10px; background: #f8f9fa;">
                    <span>âš™ï¸</span> è®¾ç½®
                </button>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šå¤šäººèŠå¤©å®¤ -->
        <div class="chat-room">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 id="session-title">å®¶åº­æ²Ÿé€šåè°ƒä¼šè¯</h3>
                    <div style="display: flex; gap: 10px; margin-top: 5px; font-size: 14px; color: #666;">
                        <span>ğŸ‘¥ å‚ä¸è€…: å¼ ä¸‰, æå››</span>
                        <span>|</span>
                        <span>ğŸ• å·²è¿›è¡Œ: 15åˆ†é’Ÿ</span>
                    </div>
                </div>
                <div class="consensus-progress" style="width: 200px;">
                    <div class="progress-bar" style="width: 65%;"></div>
                </div>
            </div>
            
            <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
            <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px;">
                <!-- æ¶ˆæ¯åŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div style="padding: 20px; border-top: 1px solid var(--border-color); background: #f8f9fa;">
                <!-- å…è´£å£°æ˜ -->
                <div class="disclaimer" id="disclaimer">
                    <strong>é‡è¦æç¤ºï¼š</strong> AIä»…æä¾›å¼•å¯¼å’Œæé—®æ”¯æŒï¼Œä¸æä¾›ä¸“ä¸šå¿ƒç†å’¨è¯¢å»ºè®®ã€‚å¦‚éœ€ä¸“ä¸šå¸®åŠ©ï¼Œè¯·å’¨è¯¢è®¤è¯å¿ƒç†å’¨è¯¢å¸ˆã€‚
                </div>
                
                <!-- è¾“å…¥æ¡† -->
                <div style="display: flex; gap: 15px;">
                    <textarea 
                        id="message-input" 
                        placeholder="è¾“å…¥æ‚¨çš„æƒ³æ³•...ï¼ˆæŒ‰Ctrl+Enterå‘é€ï¼‰"
                        style="flex: 1; padding: 15px; border: 2px solid var(--border-color); border-radius: 10px; resize: none; min-height: 60px; font-family: inherit;"
                        rows="2"
                    ></textarea>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <span>å‘é€</span>
                        </button>
                        <button class="btn" onclick="toggleVoiceInput()" style="background: #f8f9fa;">
                            <span>ğŸ¤</span>
                        </button>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿå¼•å¯¼æŒ‰é’® -->
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="aiGuide('expressFeeling')" style="font-size: 13px; padding: 8px 15px; background: #f8f9fa;">
                        ğŸ’¬ è¡¨è¾¾æ„Ÿå—
                    </button>
                    <button class="btn" onclick="aiGuide('clarifyNeeds')" style="font-size: 13px; padding: 8px 15px; background: #f8f9fa;">
                        ğŸ¯ æ¾„æ¸…éœ€æ±‚
                    </button>
                    <button class="btn" onclick="aiGuide('findCommonGround')" style="font-size: 13px; padding: 8px 15px; background: #f8f9fa;">
                        ğŸ¤ å¯»æ‰¾å…±åŒç‚¹
                    </button>
                    <button class="btn" onclick="aiGuide('suggestSolution')" style="font-size: 13px; padding: 8px 15px; background: #f8f9fa;">
                        ğŸ’¡ æ–¹æ¡ˆå»ºè®®
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šç”¨æˆ·é¢æ¿ -->
        <div class="right-panel">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">ä¼šè¯æˆå‘˜</h3>
            <div id="user-list">
                <!-- ç”¨æˆ·åŠ¨æ€åŠ è½½ -->
            </div>
            
            <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 15px; color: var(--primary-color);">å…±è¯†è¿›åº¦</h4>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>ç†è§£é˜¶æ®µ</span>
                        <span>65%</span>
                    </div>
                    <div class="consensus-progress">
                        <div class="progress-bar" style="width: 65%;"></div>
                    </div>
                    <div style="font-size: 13px; color: #666; margin-top: 15px;">
                        å½“å‰å…±è¯†ç‚¹ï¼šåŒæ–¹å·²ç†è§£å½¼æ­¤éœ€æ±‚
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 15px; color: var(--primary-color);">å·¥å…·</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn" onclick="exportSession()" style="justify-content: start; background: #f8f9fa;">
                        <span>ğŸ“¥</span> å¯¼å‡ºä¼šè¯è®°å½•
                    </button>
                    <button class="btn" onclick="showFileUpload()" style="justify-content: start; background: #f8f9fa;">
                        <span>ğŸ“</span> ä¸Šä¼ æ–‡ä»¶åˆ†æ
                    </button>
                    <button class="btn" onclick="showDataAnalysis()" style="justify-content: start; background: #f8f9fa;">
                        <span>ğŸ“Š</span> æƒ…ç»ªåˆ†ææŠ¥å‘Š
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modal-container"></div>
    
    <script>
        // ================= æ ¸å¿ƒé…ç½® =================
        const APP_CONFIG = {
            appName: "ConsensusAI",
            version: "1.0.0",
            maxUsersPerSession: 20,
            sessionTimeout: 3600, // 1å°æ—¶
            aiGuidanceModes: {
                family: "å®¶åº­å…³ç³»åè°ƒ",
                couple: "ä¼´ä¾£æ²Ÿé€š",
                workplace: "èŒåœºåä½œ",
                friendship: "æœ‹å‹å…³ç³»"
            }
        };
        
        // ================= çŠ¶æ€ç®¡ç† =================
        let currentSession = null;
        let currentUsers = [];
        let chatHistory = [];
        let userProfile = {};
        
        // ================= åˆå§‹åŒ–å‡½æ•° =================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadSampleData();
        });
        
        function initializeApp() {
            // åŠ è½½ç”¨æˆ·é…ç½®
            loadUserProfile();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬
            setupEventListeners();
            
            // æ›´æ–°åœ¨çº¿çŠ¶æ€
            updateOnlineStatus();
        }
        
        function loadSampleData() {
            // ç¤ºä¾‹ä¼šè¯æ•°æ®
            currentSession = {
                id: 'session-001',
                title: 'å®¶åº­æ²Ÿé€šåè°ƒä¼šè¯',
                type: 'family',
                created: new Date(),
                users: [
                    { id: 'user-001', name: 'å¼ ä¸‰', role: 'çˆ¶äº²', color: '#3498db' },
                    { id: 'user-002', name: 'æå››', role: 'å„¿å­', color: '#2ecc71' }
                ],
                consensus: 65
            };
            
            // ç¤ºä¾‹æ¶ˆæ¯
            chatHistory = [
                {
                    id: 'msg-001',
                    userId: 'user-001',
                    userName: 'å¼ ä¸‰',
                    userRole: 'çˆ¶äº²',
                    content: 'æˆ‘å¸Œæœ›å„¿å­èƒ½æ›´ä¸“æ³¨äºå­¦ä¹ ï¼Œå°‘ç©æ‰‹æœºæ¸¸æˆã€‚',
                    timestamp: new Date(Date.now() - 3600000),
                    type: 'user'
                },
                {
                    id: 'msg-002',
                    userId: 'user-002',
                    userName: 'æå››',
                    userRole: 'å„¿å­',
                    content: 'æˆ‘è§‰å¾—å­¦ä¹ å‹åŠ›å¾ˆå¤§ï¼Œç©æ¸¸æˆæ˜¯æ”¾æ¾çš„æ–¹å¼ã€‚',
                    timestamp: new Date(Date.now() - 3540000),
                    type: 'user'
                },
                {
                    id: 'msg-003',
                    userId: 'ai',
                    userName: 'AIå¼•å¯¼å¸ˆ',
                    content: 'æˆ‘ç†è§£åŒæ–¹éƒ½æœ‰è‡ªå·±çš„éœ€æ±‚å’Œå›°æ‰°ã€‚è®©æˆ‘ä»¬å…ˆæ˜ç¡®ä¸€ä¸‹æ ¸å¿ƒé—®é¢˜ï¼šçˆ¶äº²å…³å¿ƒçš„æ˜¯å­¦ä¸šæˆç»©ï¼Œå„¿å­éœ€è¦çš„æ˜¯å‹åŠ›é‡Šæ”¾ã€‚æˆ‘ä»¬å¯ä»¥ä¸€èµ·å¯»æ‰¾æ—¢èƒ½ä¿è¯å­¦ä¹ æ•ˆæœï¼Œåˆèƒ½é€‚å½“æ”¾æ¾çš„æ–¹æ¡ˆå—ï¼Ÿ',
                    timestamp: new Date(Date.now() - 3500000),
                    type: 'ai'
                }
            ];
            
            // æ¸²æŸ“ç•Œé¢
            renderSession();
            renderMessages();
            renderUserList();
        }
        
        // ================= æ¸²æŸ“å‡½æ•° =================
        function renderSession() {
            if (currentSession) {
                document.getElementById('session-title').textContent = currentSession.title;
                updateConsensusProgress(currentSession.consensus);
            }
        }
        
        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            
            chatHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type === 'user' ? 'user-message' : 'ai-message'}`;
                
                // ç”¨æˆ·ä¿¡æ¯
                const userInfo = document.createElement('div');
                userInfo.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 14px;';
                
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.style.background = msg.type === 'user' ? 
                    (currentSession.users.find(u => u.id === msg.userId)?.color || '#3498db') : 
                    'linear-gradient(135deg, #9b59b6, #8e44ad)';
                avatar.textContent = msg.userName.charAt(0);
                
                const infoText = document.createElement('div');
                infoText.innerHTML = `<strong>${msg.userName}</strong> ${msg.userRole ? `<span style="color: #666; font-size: 12px;">(${msg.userRole})</span>` : ''}`;
                
                userInfo.appendChild(avatar);
                userInfo.appendChild(infoText);
                
                // æ¶ˆæ¯å†…å®¹
                const content = document.createElement('div');
                content.textContent = msg.content;
                
                // æ—¶é—´æˆ³
                const time = document.createElement('div');
                time.style.cssText = 'font-size: 12px; color: #999; margin-top: 8px; text-align: right;';
                time.textContent = formatTime(msg.timestamp);
                
                messageDiv.appendChild(userInfo);
                messageDiv.appendChild(content);
                messageDiv.appendChild(time);
                
                container.appendChild(messageDiv);
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }
        
        function renderUserList() {
            const container = document.getElementById('user-list');
            container.innerHTML = '';
            
            currentSession.users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;';
                
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.style.background = user.color;
                avatar.textContent = user.name.charAt(0);
                
                const info = document.createElement('div');
                info.innerHTML = `
                    <div style="font-weight: 600;">${user.name}</div>
                    <div style="font-size: 13px; color: #666;">${user.role}</div>
                `;
                
                const status = document.createElement('div');
                status.style.cssText = 'width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; margin-left: auto;';
                
                userDiv.appendChild(avatar);
                userDiv.appendChild(info);
                userDiv.appendChild(status);
                
                container.appendChild(userDiv);
            });
        }
        
        // ================= æ ¸å¿ƒåŠŸèƒ½ =================
        function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content) return;
            
            // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
            const newMessage = {
                id: 'msg-' + Date.now(),
                userId: 'user-001', // å½“å‰ç”¨æˆ·ID
                userName: 'å¼ ä¸‰', // å½“å‰ç”¨æˆ·å
                userRole: 'çˆ¶äº²',
                content: content,
                timestamp: new Date(),
                type: 'user'
            };
            
            // æ·»åŠ åˆ°å†å²
            chatHistory.push(newMessage);
            
            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            adjustInputHeight();
            
            // AIè‡ªåŠ¨å“åº”ï¼ˆæ¨¡æ‹Ÿï¼‰
            setTimeout(() => {
                aiResponse(content);
            }, 1000);
        }
        
        function aiResponse(userMessage) {
            const responses = {
                lowConsensus: [
                    "æˆ‘æ³¨æ„åˆ°åŒæ–¹æœ‰ä¸åŒçš„çœ‹æ³•ã€‚è®©æˆ‘ä»¬å…ˆå„è‡ªè¡¨è¾¾ä¸€ä¸‹å¯¹è¿™ä¸ªé—®é¢˜çš„æœ€çœŸå®æ„Ÿå—å¥½å—ï¼Ÿ",
                    "çœ‹èµ·æ¥æˆ‘ä»¬éœ€è¦æ›´å¤šç†è§£å½¼æ­¤çš„è§’åº¦ã€‚æ‚¨èƒ½è¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™ä»¶äº‹å¯¹æ‚¨å¦‚æ­¤é‡è¦å—ï¼Ÿ",
                    "æˆ‘ç†è§£è¿™å¯èƒ½æœ‰æŒ‘æˆ˜æ€§ã€‚æˆ‘ä»¬å¯ä»¥å°è¯•ä»ä¸€ä¸ªæ›´ä¸­ç«‹çš„è§’åº¦æ¥çœ‹è¿™ä¸ªé—®é¢˜å—ï¼Ÿ"
                ],
                mediumConsensus: [
                    "å¾ˆå¥½ï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†ä¸€äº›å…±åŒç‚¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥è®¨è®ºä¸€ä¸‹å„è‡ªçš„åº•çº¿éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ",
                    "æˆ‘æ¬£èµåŒæ–¹éƒ½æ„¿æ„æ²Ÿé€šçš„æ€åº¦ã€‚ç°åœ¨æˆ‘ä»¬æ˜¯å¦å¯ä»¥è€ƒè™‘ä¸€äº›æŠ˜ä¸­çš„æ–¹æ¡ˆï¼Ÿ",
                    "è®©æˆ‘ä»¬è¯•ç€æŠŠå„è‡ªçš„éœ€æ±‚åˆ—å‡ºæ¥ï¼Œçœ‹çœ‹å“ªäº›æ˜¯å¯ä»¥äº’ç›¸æ»¡è¶³çš„ã€‚"
                ],
                highConsensus: [
                    "æˆ‘ä»¬å·²ç»å–å¾—äº†å¾ˆå¤§è¿›å±•ï¼æ˜¯å¦å¯ä»¥è€ƒè™‘ä¸€ä¸ªè¯•è¡Œæ–¹æ¡ˆï¼Œçœ‹çœ‹æ•ˆæœå¦‚ä½•ï¼Ÿ",
                    "åŸºäºç›®å‰çš„å…±è¯†ï¼Œæˆ‘å»ºè®®æˆ‘ä»¬å¯ä»¥åˆ¶å®šä¸€ä¸ªå…·ä½“çš„è¡ŒåŠ¨è®¡åˆ’ã€‚",
                    "å¾ˆé«˜å…´çœ‹åˆ°åŒæ–¹è¾¾æˆç†è§£ã€‚æˆ‘ä»¬å¯ä»¥æ€»ç»“ä¸€ä¸‹è¾¾æˆçš„å…±è¯†ç‚¹å—ï¼Ÿ"
                ]
            };
            
            // æ ¹æ®å…±è¯†ç¨‹åº¦é€‰æ‹©å›å¤
            let responseType = 'lowConsensus';
            if (currentSession.consensus > 70) responseType = 'highConsensus';
            else if (currentSession.consensus > 40) responseType = 'mediumConsensus';
            
            const response = responses[responseType][Math.floor(Math.random() * responses[responseType].length)];
            
            const aiMessage = {
                id: 'msg-' + Date.now(),
                userId: 'ai',
                userName: 'AIå¼•å¯¼å¸ˆ',
                content: response + '\n\n<small style="color: #666;">è¯·æ³¨æ„ï¼šAIä»…æä¾›å¼•å¯¼æ”¯æŒï¼Œä¸æä¾›ä¸“ä¸šå»ºè®®ã€‚</small>',
                timestamp: new Date(),
                type: 'ai'
            };
            
            chatHistory.push(aiMessage);
            renderMessages();
            
            // æ›´æ–°å…±è¯†è¿›åº¦ï¼ˆæ¨¡æ‹Ÿï¼‰
            updateConsensusProgress(currentSession.consensus + 5);
        }
        
        // ================= è¾…åŠ©å‡½æ•° =================
        function aiGuide(mode) {
            const guides = {
                expressFeeling: "è¯·è¯•ç€ç”¨'æˆ‘æ„Ÿåˆ°...å½“...å› ä¸º...'çš„å¥å¼æ¥è¡¨è¾¾æ‚¨çš„æ„Ÿå—ã€‚",
                clarifyNeeds: "è¯·é—®æ‚¨åœ¨è¿™ä»¶äº‹ä¸­æœ€æ ¸å¿ƒçš„éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯æœ€ä¸èƒ½å¦¥åçš„ï¼Ÿ",
                findCommonGround: "æˆ‘ä»¬å¯ä»¥å…ˆåˆ—å‡ºåŒæ–¹éƒ½è®¤åŒçš„äº‹å®æˆ–ä»·å€¼è§‚å—ï¼Ÿ",
                suggestSolution: "åŸºäºç›®å‰çš„è®¨è®ºï¼Œæ‚¨è®¤ä¸ºå“ªäº›æ–¹æ¡ˆæ˜¯åŒæ–¹éƒ½å¯èƒ½æ¥å—çš„ï¼Ÿ"
            };
            
            const input = document.getElementById('message-input');
            input.value = guides[mode] + '\n' + (input.value || '');
            adjustInputHeight();
        }
        
        function updateConsensusProgress(percent) {
            if (percent > 100) percent = 100;
            if (percent < 0) percent = 0;
            
            currentSession.consensus = percent;
            document.querySelector('.progress-bar').style.width = percent + '%';
            
            // æ›´æ–°å…±è¯†æ–‡æœ¬
            let consensusText = '';
            if (percent < 30) consensusText = 'åˆæ­¥äº¤æµé˜¶æ®µ';
            else if (percent < 60) consensusText = 'ç›¸äº’ç†è§£é˜¶æ®µ';
            else if (percent < 80) consensusText = 'å…±è¯†å½¢æˆé˜¶æ®µ';
            else consensusText = 'æ¥è¿‘è¾¾æˆå…±è¯†';
            
            document.querySelector('.progress-bar').parentElement.nextElementSibling.textContent = 
                `å½“å‰å…±è¯†ç‚¹ï¼š${consensusText}`;
        }
        
        function adjustInputHeight() {
            const input = document.getElementById('message-input');
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 120) + 'px';
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        function updateOnlineStatus() {
            const count = currentSession ? currentSession.users.length : 0;
            document.getElementById('online-count').textContent = `åœ¨çº¿: ${count}äºº`;
        }
        
        // ================= æ¨¡æ€æ¡†å‡½æ•° =================
        function showNewSessionModal() {
            alert('æ–°å»ºä¼šè¯åŠŸèƒ½ - å°†åœ¨å®Œæ•´ç‰ˆä¸­å®ç°');
            // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»ºæ–°ä¼šè¯çš„å®Œæ•´é€»è¾‘
        }
        
        function inviteUsers() {
            alert('é‚€è¯·æˆå‘˜åŠŸèƒ½ - å°†åœ¨å®Œæ•´ç‰ˆä¸­å®ç°');
            // è¿™é‡Œå¯ä»¥æ·»åŠ é‚€è¯·ç”¨æˆ·çš„å®Œæ•´é€»è¾‘
        }
        
        function showSettings() {
            alert('è®¾ç½®åŠŸèƒ½ - å°†åœ¨å®Œæ•´ç‰ˆä¸­å®ç°');
            // è¿™é‡Œå¯ä»¥æ·»åŠ è®¾ç½®é¡µé¢çš„å®Œæ•´é€»è¾‘
        }
        
        // ================= å·¥å…·å‡½æ•° =================
        function toggleVoiceInput() {
            alert('è¯­éŸ³è¾“å…¥åŠŸèƒ½ - å°†åœ¨å®Œæ•´ç‰ˆä¸­å®ç°');
            // è¿™é‡Œå¯ä»¥æ·»åŠ è¯­éŸ³è¾“å…¥çš„å®Œæ•´é€»è¾‘
        }
        
        function exportSession() {
            const sessionData = {
                session: currentSession,
                messages: chatHistory,
                exportTime: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `consensusai-session-${currentSession.id}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ä¼šè¯è®°å½•å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶');
        }
        
        function showFileUpload() {
            alert('æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ - å°†åœ¨å®Œæ•´ç‰ˆä¸­å®ç°');
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶ä¸Šä¼ çš„å®Œæ•´é€»è¾‘
        }
        
        function showDataAnalysis() {
            alert('æƒ…ç»ªåˆ†ææŠ¥å‘Š - å°†åœ¨å®Œæ•´ç‰ˆä¸­å®ç°');
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ•°æ®åˆ†æçš„å®Œæ•´é€»è¾‘
        }
        
        // ================= äº‹ä»¶ç›‘å¬ =================
        function setupEventListeners() {
            const input = document.getElementById('message-input');
            
            // Ctrl+Enter å‘é€
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // è¾“å…¥æ¡†é«˜åº¦è‡ªé€‚åº”
            input.addEventListener('input', adjustInputHeight);
        }
        
        // ================= ç”¨æˆ·é…ç½® =================
        function loadUserProfile() {
            const saved = localStorage.getItem('consensusai_profile');
            if (saved) {
                userProfile = JSON.parse(saved);
            } else {
                userProfile = {
                    name: 'å¼ ä¸‰',
                    subscription: 'professional',
                    settings: {
                        theme: 'light',
                        notifications: true,
                        autoSave: true
                    }
                };
            }
        }
        
        function saveUserProfile() {
            localStorage.setItem('consensusai_profile', JSON.stringify(userProfile));
        }
    </script>
    <!-- åœ¨ä½ çš„index.htmlä¸­ï¼Œæ‰¾åˆ°</body>æ ‡ç­¾å‰ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç  -->

<!-- ç™»å½•é€‰æ‹©æ¨¡æ€æ¡† -->
<div id="auth-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
    <div style="background: white; padding: 40px 30px; border-radius: 20px; width: 90%; max-width: 380px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative;">
        <button id="close-auth" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; color: #999; cursor: pointer;">Ã—</button>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #6a11cb, #2575fc); border-radius: 15px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">C</div>
            <h2 style="color: #2c3e50; margin-bottom: 8px;">æ¬¢è¿ä½¿ç”¨ ConsensusAI</h2>
            <p style="color: #666; font-size: 14px;">ä¸“ä¸šå¿ƒç†å’¨è¯¢åä½œå¹³å°</p>
        </div>
        
        <!-- ç¤¾äº¤ç™»å½•æŒ‰é’® -->
        <div style="margin-bottom: 25px;">
            <h4 style="margin-bottom: 15px; color: #555; text-align: center; font-weight: 500;">å¿«é€Ÿç™»å½•</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="social-btn wechat" onclick="wechatLogin()">
                    <span style="font-size: 18px;">ğŸ’š</span> å¾®ä¿¡ç™»å½•
                </button>
                <button class="social-btn qq" onclick="qqLogin()">
                    <span style="font-size: 18px;">ğŸ§</span> QQç™»å½•
                </button>
                <button class="social-btn phone" onclick="showPhoneLogin()">
                    <span style="font-size: 18px;">ğŸ“±</span> æ‰‹æœºç™»å½•
                </button>
                <button class="social-btn email" onclick="showEmailLogin()">
                    <span style="font-size: 18px;">ğŸ“§</span> é‚®ç®±ç™»å½•
                </button>
            </div>
        </div>
        
        <!-- æ‰‹æœºç™»å½•è¡¨å• -->
        <div id="phone-login-form" style="display: none; margin-top: 20px;">
            <h4 style="margin-bottom: 15px; color: #555;">æ‰‹æœºå·ç™»å½•</h4>
            <div style="margin-bottom: 15px;">
                <input type="tel" id="phone-number" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" style="width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px;">
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="verify-code" placeholder="éªŒè¯ç " style="flex: 1; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px;">
                <button id="send-code-btn" style="padding: 0 20px; background: #f0f2f5; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; cursor: pointer;">
                    è·å–éªŒè¯ç 
                </button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="phoneLogin()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                    ç™»å½•/æ³¨å†Œ
                </button>
                <button onclick="hideForms()" style="padding: 14px 20px; background: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 10px; font-weight: 500; cursor: pointer;">
                    è¿”å›
                </button>
            </div>
        </div>
        
        <!-- é‚®ç®±ç™»å½•è¡¨å• -->
        <div id="email-login-form" style="display: none; margin-top: 20px;">
            <h4 style="margin-bottom: 15px; color: #555;">é‚®ç®±ç™»å½•</h4>
            <div style="margin-bottom: 15px;">
                <input type="email" id="email-input" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" style="width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px;">
            </div>
            <div style="margin-bottom: 20px;">
                <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç " style="width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="emailLogin()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                    ç™»å½•
                </button>
                <button onclick="emailSignup()" style="padding: 14px 20px; background: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 10px; font-weight: 500; cursor: pointer;">
                    æ³¨å†Œ
                </button>
                <button onclick="hideForms()" style="padding: 14px 20px; background: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 10px; font-weight: 500; cursor: pointer;">
                    è¿”å›
                </button>
            </div>
        </div>
        
        <!-- ç”¨æˆ·åè®® -->
        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; text-align: center;">
            <p style="font-size: 12px; color: #999; line-height: 1.5;">
                ç™»å½•å³è¡¨ç¤ºåŒæ„ <a href="#" style="color: #6a11cb;">ç”¨æˆ·åè®®</a> å’Œ <a href="#" style="color: #6a11cb;">éšç§æ”¿ç­–</a>
                <br>æœ¬å¹³å°ä»…æä¾›å¼•å¯¼æ”¯æŒï¼Œä¸æä¾›ä¸“ä¸šå¿ƒç†å’¨è¯¢
            </p>
        </div>
    </div>
</div>

<!-- å¾®ä¿¡æ‰«ç æ¨¡æ€æ¡† -->
<div id="wechat-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2001; justify-content: center; align-items: center;">
    <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 320px;">
        <h3 style="margin-bottom: 20px; color: #2c3e50;">å¾®ä¿¡æ‰«ç ç™»å½•</h3>
        <div id="wechat-qrcode" style="width: 200px; height: 200px; background: #f5f5f5; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #666;">
            <!-- è¿™é‡Œæ˜¾ç¤ºå¾®ä¿¡äºŒç»´ç  -->
            å¾®ä¿¡æ‰«ç åŠŸèƒ½éœ€åç«¯æ”¯æŒ
        </div>
        <p style="color: #666; font-size: 14px; margin-bottom: 25px;">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç ç™»å½•</p>
        <div style="display: flex; gap: 10px;">
            <button onclick="closeWechatModal()" style="flex: 1; padding: 12px; background: #f8f9fa; color: #333; border: 1px solid #ddd; border-radius: 10px; cursor: pointer;">
                å–æ¶ˆ
            </button>
            <button onclick="simulateWechatLogin()" style="flex: 1; padding: 12px; background: #07c160; color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                æ¨¡æ‹Ÿç™»å½•
            </button>
        </div>
    </div>
</div>

<style>
    /* ç¤¾äº¤ç™»å½•æŒ‰é’®æ ·å¼ */
    .social-btn {
        padding: 14px;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        background: white;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .social-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .social-btn.wechat:hover { border-color: #07c160; background: #f0fff4; }
    .social-btn.qq:hover { border-color: #12b7f5; background: #f0f9ff; }
    .social-btn.phone:hover { border-color: #6a11cb; background: #f5f0ff; }
    .social-btn.email:hover { border-color: #2575fc; background: #f0f5ff; }
</style>

<script>
// ================= ç”¨æˆ·ç³»ç»Ÿé…ç½® =================
const USER_CONFIG = {
    // æ”¯æŒçš„ç™»å½•æ–¹å¼
    loginMethods: ['wechat', 'phone', 'qq', 'email'],
    
    // ç”¨æˆ·ç±»å‹
    userTypes: {
        free: {
            name: 'å…è´¹ç”¨æˆ·',
            maxSessions: 2,
            maxParticipants: 2,
            features: ['åŸºç¡€å¯¹è¯', 'ç®€å•å¼•å¯¼']
        },
        professional: {
            name: 'ä¸“ä¸šç”¨æˆ·',
            maxSessions: 10,
            maxParticipants: 5,
            features: ['é«˜çº§å¼•å¯¼', 'æ–‡ä»¶åˆ†æ', 'æ•°æ®å¯¼å‡º']
        },
        enterprise: {
            name: 'ä¼ä¸šç”¨æˆ·',
            maxSessions: 50,
            maxParticipants: 20,
            features: ['å›¢é˜Ÿç®¡ç†', 'APIæ¥å…¥', 'å®šåˆ¶åŠŸèƒ½']
        }
    },
    
    // é»˜è®¤è®¾ç½®
    defaultSettings: {
        theme: 'light',
        language: 'zh-CN',
        notifications: true,
        autoSave: true,
        privacy: 'private'
    }
};

// ================= å…¨å±€çŠ¶æ€ =================
let currentUser = null;
let authModal = document.getElementById('auth-modal');
let wechatModal = document.getElementById('wechat-modal');

// ================= åˆå§‹åŒ– =================
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkLoginStatus();
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    setupAuthListeners();
});

// æ£€æŸ¥ç™»å½•çŠ¶æ€
function checkLoginStatus() {
    const savedUser = localStorage.getItem('consensusai_user_v2');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            if (currentUser && currentUser.id) {
                // ç”¨æˆ·å·²ç™»å½•ï¼Œæ›´æ–°UI
                updateUIForLoggedInUser();
                return;
            }
        } catch (e) {
            console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
        }
    }
    
    // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
    setTimeout(() => {
        authModal.style.display = 'flex';
    }, 1500);
}

// ================= ç™»å½•åŠŸèƒ½ =================

// å¾®ä¿¡ç™»å½•
function wechatLogin() {
    // æ˜¾ç¤ºå¾®ä¿¡æ‰«ç æ¨¡æ€æ¡†
    authModal.style.display = 'none';
    wechatModal.style.display = 'flex';
    
    // è¿™é‡Œåº”è¯¥ç”ŸæˆçœŸå®çš„å¾®ä¿¡äºŒç»´ç 
    // æš‚æ—¶ç”¨æ¨¡æ‹ŸåŠŸèƒ½
}

function closeWechatModal() {
    wechatModal.style.display = 'none';
    authModal.style.display = 'flex';
}

function simulateWechatLogin() {
    // æ¨¡æ‹Ÿå¾®ä¿¡ç™»å½•æˆåŠŸ
    const userData = {
        id: 'wx_' + Date.now(),
        type: 'wechat',
        nickname: 'å¾®ä¿¡ç”¨æˆ·_' + Math.floor(Math.random() * 1000),
        avatar: 'https://api.multiavatar.com/' + Date.now() + '.svg',
        unionid: 'mock_unionid_' + Date.now(),
        subscription: 'free',
        settings: USER_CONFIG.defaultSettings,
        created: new Date().toISOString(),
        lastLogin: new Date().toISOString()
    };
    
    loginSuccess(userData, 'å¾®ä¿¡');
}

// æ˜¾ç¤ºæ‰‹æœºç™»å½•è¡¨å•
function showPhoneLogin() {
    document.getElementById('phone-login-form').style.display = 'block';
    document.getElementById('email-login-form').style.display = 'none';
    
    // ç»‘å®šè·å–éªŒè¯ç äº‹ä»¶
    document.getElementById('send-code-btn').onclick = sendVerifyCode;
}

// å‘é€éªŒè¯ç 
function sendVerifyCode() {
    const phone = document.getElementById('phone-number').value;
    if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
        return;
    }
    
    const btn = document.getElementById('send-code-btn');
    btn.disabled = true;
    btn.innerHTML = '60ç§’åé‡è¯•';
    
    // æ¨¡æ‹Ÿå‘é€éªŒè¯ç 
    let count = 60;
    const timer = setInterval(() => {
        count--;
        if (count <= 0) {
            clearInterval(timer);
            btn.disabled = false;
            btn.innerHTML = 'è·å–éªŒè¯ç ';
        } else {
            btn.innerHTML = count + 'ç§’åé‡è¯•';
        }
    }, 1000);
    
    // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIå‘é€çœŸå®éªŒè¯ç 
    console.log('å‘é€éªŒè¯ç åˆ°:', phone);
    // æ¨¡æ‹ŸéªŒè¯ç ï¼š123456
    localStorage.setItem('verify_code_' + phone, '123456');
    
    alert('éªŒè¯ç å·²å‘é€ï¼ˆæ¨¡æ‹Ÿï¼š123456ï¼‰');
}

// æ‰‹æœºå·ç™»å½•
function phoneLogin() {
    const phone = document.getElementById('phone-number').value;
    const code = document.getElementById('verify-code').value;
    
    if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
        return;
    }
    
    if (!code || code.length !== 6) {
        alert('è¯·è¾“å…¥6ä½éªŒè¯ç ');
        return;
    }
    
    // éªŒè¯éªŒè¯ç ï¼ˆæ¨¡æ‹Ÿï¼‰
    const savedCode = localStorage.getItem('verify_code_' + phone);
    if (code !== savedCode && code !== '123456') {
        alert('éªŒè¯ç é”™è¯¯');
        return;
    }
    
    // ç™»å½•æˆåŠŸ
    const userData = {
        id: 'phone_' + phone,
        type: 'phone',
        phone: phone,
        nickname: 'ç”¨æˆ·_' + phone.slice(-4),
        avatar: getRandomAvatar(),
        subscription: 'free',
        settings: USER_CONFIG.defaultSettings,
        created: new Date().toISOString(),
        lastLogin: new Date().toISOString()
    };
    
    loginSuccess(userData, 'æ‰‹æœº');
}

// æ˜¾ç¤ºé‚®ç®±ç™»å½•è¡¨å•
function showEmailLogin() {
    document.getElementById('email-login-form').style.display = 'block';
    document.getElementById('phone-login-form').style.display = 'none';
}

// é‚®ç®±ç™»å½•
function emailLogin() {
    const email = document.getElementById('email-input').value;
    const password = document.getElementById('password-input').value;
    
    if (!email || !/\S+@\S+\.\S+/.test(email)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€');
        return;
    }
    
    if (!password || password.length < 6) {
        alert('å¯†ç è‡³å°‘6ä½');
        return;
    }
    
    // æ¨¡æ‹Ÿç™»å½•éªŒè¯
    const savedUser = localStorage.getItem('email_user_' + email);
    if (savedUser) {
        const user = JSON.parse(savedUser);
        if (user.password === password) {
            loginSuccess(user, 'é‚®ç®±');
            return;
        } else {
            alert('å¯†ç é”™è¯¯');
            return;
        }
    }
    
    alert('é‚®ç®±æœªæ³¨å†Œï¼Œè¯·å…ˆæ³¨å†Œ');
}

// é‚®ç®±æ³¨å†Œ
function emailSignup() {
    const email = document.getElementById('email-input').value;
    const password = document.getElementById('password-input').value;
    
    if (!email || !/\S+@\S+\.\S+/.test(email)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±åœ°å€');
        return;
    }
    
    if (!password || password.length < 6) {
        alert('å¯†ç è‡³å°‘6ä½');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œ
    if (localStorage.getItem('email_user_' + email)) {
        alert('è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•');
        return;
    }
    
    // åˆ›å»ºæ–°ç”¨æˆ·
    const userData = {
        id: 'email_' + Date.now(),
        type: 'email',
        email: email,
        password: password, // å®é™…åº”è¯¥åŠ å¯†å­˜å‚¨
        nickname: email.split('@')[0],
        avatar: getRandomAvatar(),
        subscription: 'free',
        settings: USER_CONFIG.defaultSettings,
        created: new Date().toISOString(),
        lastLogin: new Date().toISOString()
    };
    
    // ä¿å­˜ç”¨æˆ·æ•°æ®
    localStorage.setItem('email_user_' + email, JSON.stringify(userData));
    
    loginSuccess(userData, 'é‚®ç®±');
}

// QQç™»å½•ï¼ˆæ¨¡æ‹Ÿï¼‰
function qqLogin() {
    // æ¨¡æ‹ŸQQç™»å½•
    const userData = {
        id: 'qq_' + Date.now(),
        type: 'qq',
        nickname: 'QQç”¨æˆ·_' + Math.floor(Math.random() * 1000),
        avatar: 'https://api.multiavatar.com/' + Date.now() + '.svg',
        openid: 'mock_openid_' + Date.now(),
        subscription: 'free',
        settings: USER_CONFIG.defaultSettings,
        created: new Date().toISOString(),
        lastLogin: new Date().toISOString()
    };
    
    loginSuccess(userData, 'QQ');
}

// ç™»å½•æˆåŠŸå¤„ç†
function loginSuccess(userData, loginMethod) {
    // æ›´æ–°å½“å‰ç”¨æˆ·
    currentUser = userData;
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('consensusai_user_v2', JSON.stringify(userData));
    
    // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
    authModal.style.display = 'none';
    wechatModal.style.display = 'none';
    
    // æ›´æ–°UI
    updateUIForLoggedInUser();
    
    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    showNotification(`æ¬¢è¿å›æ¥ï¼Œ${userData.nickname}ï¼ç™»å½•æ–¹å¼ï¼š${loginMethod}`);
    
    // æ›´æ–°ä¼šè¯ä¸­çš„ç”¨æˆ·ä¿¡æ¯
    updateSessionWithRealUser();
}

// ================= UIæ›´æ–° =================

// æ›´æ–°ç™»å½•åçš„UI
function updateUIForLoggedInUser() {
    if (!currentUser) return;
    
    // åˆ›å»ºç”¨æˆ·ä¿¡æ¯ç»„ä»¶
    const userInfoHTML = `
        <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="showUserMenu()">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${getUserColor(currentUser.id)}; 
                        display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">
                ${currentUser.nickname.charAt(0).toUpperCase()}
            </div>
            <div>
                <div style="font-weight: 600; font-size: 14px;">${currentUser.nickname}</div>
                <div style="font-size: 12px; color: #666; display: flex; align-items: center; gap: 4px;">
                    <span>${USER_CONFIG.userTypes[currentUser.subscription].name}</span>
                    <span style="font-size: 10px; background: #f0f2f5; padding: 2px 6px; border-radius: 10px;">
                        ${getLoginTypeIcon(currentUser.type)}
                    </span>
                </div>
            </div>
        </div>
    `;
    
    // æ·»åŠ åˆ°å¯¼èˆªæ 
    const navbarRight = document.querySelector('.navbar > div:last-child');
    navbarRight.innerHTML = userInfoHTML + navbarRight.innerHTML;
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜
    document.title = `ConsensusAI - ${currentUser.nickname}`;
}

// æ›´æ–°ä¼šè¯ä¸­çš„ç”¨æˆ·
function updateSessionWithRealUser() {
    if (!currentUser || !currentSession) return;
    
    // æ›¿æ¢æ¨¡æ‹Ÿç”¨æˆ·
    const existingUser = currentSession.users.find(u => u.id === currentUser.id);
    if (!existingUser) {
        currentSession.users.push({
            id: currentUser.id,
            name: currentUser.nickname,
            role: 'å’¨è¯¢è€…',
            color: getUserColor(currentUser.id)
        });
    }
    
    // é‡æ–°æ¸²æŸ“
    renderUserList();
}

// ================= è¾…åŠ©å‡½æ•° =================

// è·å–ç™»å½•ç±»å‹å›¾æ ‡
function getLoginTypeIcon(type) {
    const icons = {
        wechat: 'ğŸ’š',
        phone: 'ğŸ“±',
        qq: 'ğŸ§',
        email: 'ğŸ“§'
    };
    return icons[type] || 'ğŸ‘¤';
}

// è·å–ç”¨æˆ·é¢œè‰²
function getUserColor(userId) {
    const colors = ['#3498db', '#2ecc71', '#9b59b6', '#1abc9c', '#e74c3c', '#f39c12', '#34495e', '#16a085'];
    const index = userId.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0) % colors.length;
    return colors[index];
}

// éšæœºå¤´åƒ
function getRandomAvatar() {
    const avatars = [
        'https://api.multiavatar.com/1.svg',
        'https://api.multiavatar.com/2.svg',
        'https://api.multiavatar.com/3.svg',
        'https://api.multiavatar.com/4.svg',
        'https://api.multiavatar.com/5.svg'
    ];
    return avatars[Math.floor(Math.random() * avatars.length)];
}

// éšè—æ‰€æœ‰è¡¨å•
function hideForms() {
    document.getElementById('phone-login-form').style.display = 'none';
    document.getElementById('email-login-form').style.display = 'none';
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message) {
    // åˆ›å»ºé€šçŸ¥å…ƒç´ 
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        z-index: 3000;
        animation: slideIn 0.3s ease;
        border-left: 4px solid #6a11cb;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ç”¨æˆ·èœå•
function showUserMenu() {
    const menuHTML = `
        <div id="user-menu" style="position: absolute; top: 60px; right: 20px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1001; width: 200px; padding: 15px 0; border: 1px solid #eee;">
            <div style="padding: 0 20px 15px; border-bottom: 1px solid #eee;">
                <div style="font-weight: 600; font-size: 15px;">${currentUser.nickname}</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">${currentUser.email || currentUser.phone || 'ç¤¾äº¤ç”¨æˆ·'}</div>
            </div>
            <div style="padding: 10px 0;">
                <div class="menu-item" onclick="goToProfile()">ğŸ‘¤ ä¸ªäººèµ„æ–™</div>
                <div class="menu-item" onclick="goToSettings()">âš™ï¸ è´¦æˆ·è®¾ç½®</div>
                <div class="menu-item" onclick="goToSubscription()">ğŸ’ å‡çº§ä¼šå‘˜</div>
                <div class="menu-item" onclick="showHelp()">â“ å¸®åŠ©ä¸­å¿ƒ</div>
            </div>
            <div style="padding: 15px 20px 0; border-top: 1px solid #eee;">
                <div class="menu-item" onclick="logout()" style="color: #e74c3c;">ğŸšª é€€å‡ºç™»å½•</div>
            </div>
        </div>
    `;
    
    // ç§»é™¤ç°æœ‰èœå•
    const existingMenu = document.getElementById('user-menu');
    if (existingMenu) existingMenu.remove();
    
    // æ·»åŠ æ–°èœå•
    document.body.insertAdjacentHTML('beforeend', menuHTML);
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            const menu = document.getElementById('user-menu');
            if (menu && !menu.contains(e.target) && !e.target.closest('.navbar > div:last-child > div')) {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 100);
}

// ç”¨æˆ·èœå•é¡¹åŠŸèƒ½
function goToProfile() {
    alert('ä¸ªäººèµ„æ–™åŠŸèƒ½å¼€å‘ä¸­...');
}

function goToSettings() {
    alert('è´¦æˆ·è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
}

function goToSubscription() {
    alert('ä¼šå‘˜å‡çº§åŠŸèƒ½å¼€å‘ä¸­...');
}

function showHelp() {
    alert('å¸®åŠ©ä¸­å¿ƒåŠŸèƒ½å¼€å‘ä¸­...');
}

// é€€å‡ºç™»å½•
function logout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        localStorage.removeItem('consensusai_user_v2');
        currentUser = null;
        location.reload();
    }
}

// è®¾ç½®äº‹ä»¶ç›‘å¬
function setupAuthListeners() {
    // å…³é—­ç™»å½•æ¨¡æ€æ¡†
    document.getElementById('close-auth').addEventListener('click', function() {
        authModal.style.display = 'none';
    });
    
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            authModal.style.display = 'none';
            wechatModal.style.display = 'none';
        }
    });
}

// æ·»åŠ CSSåŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    .menu-item {
        padding: 12px 20px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }
    .menu-item:hover {
        background: #f8f9fa;
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>

